#!/usr/bin/env bash

# Cisco AnyConnect basically takes over the routing table and routes everything
# through the VPN, so I can't use boot2docker at all while on a VPN.

# Even worse, AnyConnect does not restore the original routing entry when you
# disconnect, so it's even further screwed. This restores the route, but doesn't
# fix the problem of using boot2docker while VPN'd. (Some port forwarding can
# be sufficient for `docker images` and such, but still falls short when using
# the kitchen-docker driver).

# Cisco products: not even once.

if ! which VBoxManage 2>&1 >/dev/null; then
  echo VBoxManage not installed.
  exit 1
fi

interface=$(VBoxManage showvminfo boot2docker-vm --machinereadable 2>&1 | grep -o -E 'vboxnet\d+')
if [[ -z "${interface}" ]]; then
  echo Could not determine vboxnet interface for boot2docker-vm.
  exit 1
fi

slash24=$(ifconfig ${interface} | grep -o -E 'inet \d+.\d+.\d+' | cut -d' ' -f2)
sudo route -nv add -net ${slash24} -interface ${interface}
